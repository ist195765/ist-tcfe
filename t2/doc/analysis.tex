\section{Theoretical Analysis}
\label{sec:analysis}

In this section we will explain with some detail how do we analyse the circuit theoretically. To do so, and because there were several things to be analyse, the following subsections are going to detail the analysis of each of the six powerpoint points related to the theoretical analysis. Just as a final note, the results obtained theoretically will only be shown in the symulation section, to compare the both.

\subsection{Point 1: Determine the initial state of the circuit}

Initially, the circuits's independent voltage source inputs in the circuit a constant voltage. Because of this, and considering that the circuit is working for a really long time (started working for t = $-\infty$), we can assume that the capacitor is already fully charged and, consequentaly, it behaves like an open circuit. So to analyse the circuit's initial state we just need to do a node analysis just like we did in \textit{laboratory nº1}. 

After performing the node analysis we've obtained the following matrix:

\setlength{\parskip}{4em}

$\begin{pmatrix}
1 & 0 & 0 & -1 & 0 & 0 & 0 & 0\\
-G_1 & G_1+G_2+G_3 & -G_2 & 0 & -G_3 & 0 & 0 & 0\\
0 & -G_2-K_b & G_2 & 0 & K_b & 0 & 0 & 0 \\
G_1 & -G_1 & 0 & G_4+G_6 & -G_4 & 0 & -G_6 & 0\\
0 & 0 & 0 & -K_d*G_6 & 1 & 0 & K_d*G_6 & 0 \\
0 & K_b & 0 & 0 & -G_5-K_b & G_5 & 0 & 0 \\
0 & 0 & 0 & -G_6 & 0 & 0 & G_6+G_7 & 0  \\ 
0 & 0 & 0 & 1 & 0 & 0 & 0 & 0
\end{pmatrix}$
$\begin{pmatrix}
V_1\\
V_2\\
V_3\\
V_4\\
V_5\\
V_6\\
V_7\\
V_8
\end{pmatrix}$
=
$\begin{pmatrix}
V_s\\
0\\
0\\
0\\
0\\
0\\
0\\
0
\end{pmatrix}$

After resolving the matrix, we've obtained the theoretical results for the voltages in all nodes. 

\subsection{Point 2: Determine the equivalent resistance seen by the capacitor}

\setlength{\parskip}{1em}

To determine the equivalent resistance, we've defined a voltage source Vx between the nodes 6 and 8 and we've powered off the independent voltage source Vs. After that, we use the node analysis to determine the volatge in all nodes, which resulted in the following matrix:

\setlength{\parskip}{4em}

$\begin{pmatrix}
0 & 0 & 0 & 0 & 0 & 1 & 0 & -1\\
-G_1 & G_1+G_2+G_3 & -G_2 & 0 & -G_3 & 0 & 0 & 0\\
0 & -G_2-K_b & G_2 & 0 & K_b & 0 & 0 & 0 \\
G_1 & -G_1 & 0 & G_4+G_6 & -G_4 & 0 & -G_6 & 0\\
0 & 0 & 0 & -K_d*G_6 & 1 & 0 & K_d*G_6 & 0 \\
1 & 0 & 0 & -1 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & -G_6 & 0 & 0 & G_6+G_7 & -G_7  \\ 
0 & 0 & 0 & 1 & 0 & 0 & 0 & 0
\end{pmatrix}$
$\begin{pmatrix}
V_1\\
V_2\\
V_3\\
V_4\\
V_5\\
V_6\\
V_7\\
V_8
\end{pmatrix}$
=
$\begin{pmatrix}
V_x\\
0\\
0\\
0\\
0\\
0\\
0\\
0
\end{pmatrix}$

After knowing these voltages, it's easy to determine the currents in all branches. To determine the equivalent resistance we need to determine the current in the branch 6-8, Ix, just because $R_{eq}=V_{x}/I_{x}$. We've obtained Ix by analysing the node 8 and we've obtained the following expression for Ix:

\setlength{\parskip}{1em}

\begin{equation}
I_x = -Kb*(V_2 - V_5) + G_5*(V_5 - V_6) 
\end{equation}

After knowing Ix, we now can obtain Req, using the previous shown formula.

\subsection{Point 3: Obtaining the natural solution for the capacitor}

Using the results in point 2, we can determine the natural solution of the circuit by making a simple RC circuit, with the only components being the capacitor and the equivalent resistance, just as shown in the figure:

\begin{figure}[H]
\centering
\includegraphics[width = 10cm]{circuit3.pdf}
\caption {Circuit3}
\end{figure}

Using the Kirchhoff's voltage law for this circuit, we've obtain the folling diferential equation:

\begin{equation}
\frac{dV}{dt} + \frac{V}{C*R_{eq}} = 0
\end{equation}

Knowing that the $V_{capacitor_i} = V_{6} - V_{8}$ and using the values for these voltages obtained in point 1, the natural solution for the capacitor is given by:

\begin{equation}
V_{6n} = V_{capacitor_i} * e^{-\frac{t}{C*R_{eq}}}
\end{equation}

\begin{figure}[H]
\centering
\includegraphics[width = 8cm]{NaturalResponse.eps}
\caption {Natural Response}
\end{figure}



\subsection{Point 4: Determine the forced solution for the circuit}

We already know that in a forced circuit the voltages in all nodes will gain the same frequency as the source. Knowing this we know that the solution for the node i will be $V_{i} = V_{i_{max}}*cos(w*t + \phi_{i})$. So, in order to determine the voltages for all nodes, we just need to determine the voltages amplitudes and phases, or in other words, their complex amplitude. This brings an interesting point: if we consider the complex world the solutions will be in the form of $V_{i} = V_{i_{max}}*e^{w*t} * e^{\phi_{i}}$, which makes easy to obtain both the amplitudes and the phases.
Alongside this, we just need to solve the node analysis for all the circuit, which will result in the following matrix:

\setlength{\parskip}{4em}

$\begin{pmatrix}
1 & 0 & 0 & -1 & 0 & 0 & 0 & 0\\
-G_1 & G_1+G_2+G_3 & -G_2 & 0 & -G_3 & 0 & 0 & 0\\
0 & -G_2-K_b & G_2 & 0 & K_b & 0 & 0 & 0 \\
G_1 & -G_1 & 0 & G_4+G_6 & -G_4 & 0 & -G_6 & 0\\
0 & 0 & 0 & -K_d*G_6 & 1 & 0 & K_d*G_6 & -1 \\
0 & K_b & 0 & 0 & -G_5-K_b & G_5+\frac{1}{Z_c} & 0 & -\frac{1}{Z_c} \\
0 & 0 & 0 & -G_6 & 0 & 0 & G_6+G_7 & -G_7  \\ 
0 & 0 & 0 & 1 & 0 & 0 & 0 & 0
\end{pmatrix}$
$\begin{pmatrix}
V_1\\
V_2\\
V_3\\
V_4\\
V_5\\
V_6\\
V_7\\
V_8
\end{pmatrix}$
=
$\begin{pmatrix}
V_s\\
0\\
0\\
0\\
0\\
0\\
0\\
0
\end{pmatrix}$

As explained, all nodes will have the same frequency, so by using the complex amplitudes we can use the matrix obtained in the nodal analysis just to determine these amplitudes. To explain thsi statement let's take a look in what happens in the node 6: 

\setlength{\parskip}{1em}

\begin{equation}
K_bV_2 + (- K_b - G_5)V_5 + (G_5 + \frac{1}{Z_c})V_6 - \frac{1}{Z_c}V_8 
\end{equation}

And this is what we see in the matrix

Solving the matrix using the given values, the complex amplitudes generated are the following:

\begin{table}[H] \centering
\begin{tabular}{|
>{\columncolor[HTML]{FFCC67}}l |c|}
\hline
\multicolumn{2}{|l|}{\cellcolor[HTML]{EABD8B}Octave - Amplitude(V)} \\ \hline
\input{../doc/ComplexAmplitudes_tab}
\end{tabular}
\caption{Complex Amplitudes - Octave Results}
\end{table}

\begin{table}[H] \centering
\begin{tabular}{|
>{\columncolor[HTML]{FFCC67}}l |c|}
\hline
\multicolumn{2}{|l|}{\cellcolor[HTML]{EABD8B}Octave - Phases(degrees)} \\ \hline
\input{../doc/ComplexPhases_tab}
\end{tabular}
\caption{Complex Phases - Octave Results}
\end{table}


\subsection{Point 5: Determine the solution for the voltage in node 6}

Using the data obtained in the points 3 and 4 is relatively easy to find the solution for the voltage in the node 6. We just need to find the forced solution using the amplitude and phase for the node 6 obtained in point 4 e aplying it in this formula: $V_{6f} = V_{6_{max}}*cos(w*t + \phi_{6})$. After that it's just add it to the natural solution and we've obtained the following:

\begin{equation}
 V_{6}(t)=
    \begin{cases}
      V_{6i} & \text{para t $\in$ [-5, 0]}\\
      V_{6n}(t) + V_{6f}(t) = V_{6i}e^\frac{t}{C*R_5} + V_{6_{max}}cos(\omega t - \phi _6)
    \end{cases}       
\end{equation}

\begin{figure}[H]
\centering
\includegraphics[width = 8cm]{Solution.eps}
\caption {Natural and forced response}
\end{figure}

Note: In this plot we can also see the $V_s(t)$, which is detailed in the introduction.

\subsection{Point 6: Determine the frequency response for Vc(f), V6(f) and Vs(f)}

In this final subsection we want to determine the frequency response for Vc(f), V6(f) and Vs(f) for f belonging to [0.1;1M](Hz). To do so we've repeated the point 4 of this analysis, but varying the frequencys, which are logaritmic spaced from one another just to plot the grapth related to the $log_{10}(f)$. The results can be seen below alognside their description.

\begin{figure}[H]
\centering
\includegraphics[width = 8cm]{Amplitude.eps}
\caption {Amplitude}
\end{figure}

In the graphic shown above we can see the amplitude of the 3 voltages that we are studing. As predicted, Vs(f) is constant because is the user that inputs this value and just looking at the formula in the introduction we see that Vs = 1V during all the time studied. The value of Vs is 0 in the graph due to Vs = 1V = 20*log(1)[dB] = 0 dB. Relatively to V6(f), we see that it decreases slightly with the frequency's increase, but it tends to estabalize. As for Vc, it decreases a lot with the frequency increse, which is according to the expected, since the impedance of the capacitor is $Z_c = 1/(iwC)$.

\begin{figure}[H]
\centering
\includegraphics[width = 8cm]{Arguments.eps}
\caption {Arguments}
\end{figure}

The above graphic now details the phases of the 3 studied voltages. The phase of Vs is once more constant and equal to 0 since itś provided by input. The phases of the othe voltages tend to decrease as the frequency increses, but estabalizing near the -90 degrees for Vc and near -180 degrees for V6.  




